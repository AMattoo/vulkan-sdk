<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>Vulkan SDK for Android 1.1.1: Using Validation Layers for Debugging Applications</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function()
{ (i[r].q=i[r].q||[]).push(arguments)}
,i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-35797182-1', 'auto');
ga('send', 'pageview');
</script>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="stylesheet.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0" width="100%">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="top_banner.bmp"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">Vulkan SDK for Android 1.1.1
<span id="malidevcenter"><a href="http://malideveloper.arm.com">Mali Developer Center</a></span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('_validation_layer.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Using Validation Layers for Debugging Applications </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>Introduces how to use the LunarG Validation Layers with your Vulkan application.</p>
<h1><a class="anchor" id="VLIntro"></a>
Introduction</h1>
<p>Vulkan is a layered architecture which was designed to allow easy plugging of external code to "hook" a Vulkan application. There is no more LD_PRELOAD or similar intrusive approaches to hook GLES implementations.</p>
<h2><a class="anchor" id="VLLoader"></a>
The Loader</h2>
<p>The loader is the system library which applications link against. The loaders job is to discover various layers and installable client drivers (ICD) and plug them together.</p>
<h2><a class="anchor" id="VLLayers"></a>
The Layer</h2>
<p>A layer is a dynamic library which partially implements the Vulkan API. The main use for layers is to implement validation on top of Vulkan. In release mode, drivers will assume that applications are correct, and invalid API calls cannot happen. This allows a driver to avoid wasting a lot of time on error checking code. During development, validation layers can be plugged in to add a vendor-neutral framework for debugging and validation.</p>
<p>When layers are enabled, they may hook any Vulkan call the application wants to call. To report errors back to the application, there is an extension VK_EXT_debug_report which enables you to register a callback which may be called when a layer detects an error. From there, it is very easy to set a breakpoint in that callback and inspect the callback to figure out exactly where the error was made when debugging an application.</p>
<h2><a class="anchor" id="VLDriver"></a>
The Installable Client Driver</h2>
<p>The driver itself is the end point when calling into a Vulkan entry point. After the optional layers have done their validation, the driver is called in the end.</p>
<h1><a class="anchor" id="VLBundling"></a>
Bundling Validation Layers in the Android APK</h1>
<p>On desktop systems, validation layers are installed for you, but on Android, you will want to bundle the validation layers with the APK. The Android NDK bundles a pre-built set of validation layers which you can copy directly over to the APK. We can add a small CMake snippet to do this automatically.</p>
<div class="fragment"><div class="line"><span class="preprocessor"># From platform/android/CMakeLists.txt</span></div><div class="line"><span class="preprocessor"># Include Validation layers in the APK</span></div><div class="line"><span class="preprocessor"># platform-android can be replaced with any target, for example your native library</span></div><div class="line"><span class="keyword">set</span>(layer-files ${ANDROID_NDK}/sources/third_party/vulkan/src/build-android/jniLibs/${ANDROID_ABI})</div><div class="line">file(GLOB layers ${layer-files}<span class="comment">/*.so)</span></div><div class="line"><span class="comment">foreach(layer ${layers})</span></div><div class="line"><span class="comment">file(MAKE_DIRECTORY ${CMAKE_LIBRARY_OUTPUT_DIRECTORY})</span></div><div class="line"><span class="comment">add_custom_command(TARGET platform-android POST_BUILD</span></div><div class="line"><span class="comment">    COMMAND ${CMAKE_COMMAND} -E copy ${layer} ${CMAKE_LIBRARY_OUTPUT_DIRECTORY})</span></div><div class="line"><span class="comment">endforeach()</span></div></div><!-- fragment --><p>Once you have layers in your APK library folder, the loader will find them during layer enumeration.</p>
<h1><a class="anchor" id="VLEnabling"></a>
Enabling Validation Layers</h1>
<p>Before creating a VkInstance, we can query which layers are available on the system.</p>
<div class="fragment"><div class="line">uint32_t instanceLayerCount;</div><div class="line">VK_CHECK(vkEnumerateInstanceLayerProperties(&amp;instanceLayerCount, <span class="keyword">nullptr</span>));</div><div class="line">vector&lt;VkLayerProperties&gt; instanceLayers(instanceLayerCount);</div><div class="line">VK_CHECK(vkEnumerateInstanceLayerProperties(&amp;instanceLayerCount, instanceLayers.data()));</div></div><!-- fragment --><p>We can also query here if any layer supports extensions, VK_EXT_debug_report is a good candidate to check for here, generally, the loader will expose this extension as well.</p>
<div class="fragment"><div class="line"><span class="comment">// A layer could have VK_EXT_debug_report extension.</span></div><div class="line"><span class="keywordflow">for</span> (<span class="keyword">auto</span> &amp;layer : instanceLayers)</div><div class="line">{</div><div class="line">        uint32_t count;</div><div class="line">        VK_CHECK(vkEnumerateInstanceExtensionProperties(layer.layerName, &amp;count, <span class="keyword">nullptr</span>));</div><div class="line">        vector&lt;VkExtensionProperties&gt; extensions(count);</div><div class="line">        VK_CHECK(vkEnumerateInstanceExtensionProperties(layer.layerName, &amp;count, extensions.data()));</div><div class="line">        <span class="keywordflow">for</span> (<span class="keyword">auto</span> &amp;ext : extensions)</div><div class="line">                instanceExtensions.push_back(ext);</div><div class="line">}</div></div><!-- fragment --><p>We should now loop over the layers we found and enable the ones that are present and relevant for validation.</p>
<div class="fragment"><div class="line"><span class="preprocessor">#define NELEMS(x) (sizeof(x) / sizeof((x)[0]))</span></div><div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *pValidationLayers[] = {</div><div class="line">        <span class="stringliteral">&quot;VK_LAYER_GOOGLE_threading&quot;</span>,       <span class="stringliteral">&quot;VK_LAYER_LUNARG_parameter_validation&quot;</span>, <span class="stringliteral">&quot;VK_LAYER_LUNARG_object_tracker&quot;</span>,</div><div class="line">        <span class="stringliteral">&quot;VK_LAYER_LUNARG_core_validation&quot;</span>, <span class="stringliteral">&quot;VK_LAYER_LUNARG_device_limits&quot;</span>,        <span class="stringliteral">&quot;VK_LAYER_LUNARG_image&quot;</span>,</div><div class="line">        <span class="stringliteral">&quot;VK_LAYER_LUNARG_swapchain&quot;</span>,       <span class="stringliteral">&quot;VK_LAYER_GOOGLE_unique_objects&quot;</span>,</div><div class="line">};</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *pMetaLayers[] = {</div><div class="line">        <span class="stringliteral">&quot;VK_LAYER_LUNARG_standard_validation&quot;</span>,</div><div class="line">};</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> addSupportedLayers(vector&lt;const char *&gt; &amp;activeLayers, <span class="keyword">const</span> vector&lt;VkLayerProperties&gt; &amp;instanceLayers,</div><div class="line">                               <span class="keyword">const</span> <span class="keywordtype">char</span> **ppRequested, <span class="keywordtype">unsigned</span> numRequested)</div><div class="line">{</div><div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> i = 0; i &lt; numRequested; i++)</div><div class="line">        {</div><div class="line">                <span class="keyword">auto</span> *layer = ppRequested[i];</div><div class="line">                <span class="keywordflow">for</span> (<span class="keyword">auto</span> &amp;ext : instanceLayers)</div><div class="line">                {</div><div class="line">                        <span class="keywordflow">if</span> (strcmp(ext.layerName, layer) == 0)</div><div class="line">                        {</div><div class="line">                                activeLayers.push_back(layer);</div><div class="line">                                <span class="keywordflow">break</span>;</div><div class="line">                        }</div><div class="line">                }</div><div class="line">        }</div><div class="line">}</div><div class="line"></div><div class="line">{</div><div class="line">        <span class="comment">// On desktop, the LunarG loader exposes a meta-layer that combines all</span></div><div class="line">        <span class="comment">// relevant validation layers.</span></div><div class="line">        vector&lt;const char *&gt; activeLayers;</div><div class="line">        addSupportedLayers(activeLayers, instanceLayers, pMetaLayers, NELEMS(pMetaLayers));</div><div class="line"></div><div class="line">        <span class="comment">// On Android, add all relevant layers one by one.</span></div><div class="line">        <span class="keywordflow">if</span> (activeLayers.empty())</div><div class="line">        {</div><div class="line">                addSupportedLayers(activeLayers, instanceLayers, pValidationLayers, NELEMS(pValidationLayers));</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="keywordflow">if</span> (activeLayers.empty())</div><div class="line">                LOGI(<span class="stringliteral">&quot;Did not find validation layers.\n&quot;</span>);</div><div class="line">        <span class="keywordflow">else</span></div><div class="line">                LOGI(<span class="stringliteral">&quot;Found validation layers!\n&quot;</span>);</div><div class="line">}</div></div><!-- fragment --><dl class="section note"><dt>Note</dt><dd>Desktop loader current exposes a meta-layer "VK_LAYER_LUNARG_standard_validation" which automatically enables all validation layers, but this doesn't yet exist for Android.</dd></dl>
<p>Once we have found our layers, we need to enable them during both instance creation and device creation.</p>
<div class="fragment"><div class="line"><span class="preprocessor">#if ENABLE_VALIDATION_LAYERS</span></div><div class="line">        <span class="keywordflow">if</span> (!activeLayers.empty())</div><div class="line">        {</div><div class="line">                instanceInfo.enabledLayerCount = activeLayers.size();</div><div class="line">                instanceInfo.ppEnabledLayerNames = activeLayers.data();</div><div class="line">                LOGI(<span class="stringliteral">&quot;Using Vulkan instance validation layers.\n&quot;</span>);</div><div class="line">        }</div><div class="line"><span class="preprocessor">#endif</span></div></div><!-- fragment --><p>Similar to instance, we can query the physical device for layers.</p>
<div class="fragment"><div class="line">uint32_t deviceLayerCount;</div><div class="line">VK_CHECK(vkEnumerateDeviceLayerProperties(gpu, &amp;deviceLayerCount, <span class="keyword">nullptr</span>));</div><div class="line">vector&lt;VkLayerProperties&gt; deviceLayers(deviceLayerCount);</div><div class="line">VK_CHECK(vkEnumerateDeviceLayerProperties(gpu, &amp;deviceLayerCount, deviceLayers.data()));</div><div class="line"></div><div class="line">activeLayers.clear();</div><div class="line"><span class="comment">// On desktop, the LunarG loader exposes a meta-layer that combines all</span></div><div class="line"><span class="comment">// relevant validation layers.</span></div><div class="line">addSupportedLayers(activeLayers, deviceLayers, pMetaLayers, NELEMS(pMetaLayers));</div><div class="line"></div><div class="line"><span class="comment">// On Android, add all relevant layers one by one.</span></div><div class="line"><span class="keywordflow">if</span> (activeLayers.empty())</div><div class="line">{</div><div class="line">        addSupportedLayers(activeLayers, deviceLayers, pValidationLayers, NELEMS(pValidationLayers));</div><div class="line">}</div><div class="line"></div><div class="line"><span class="preprocessor">#if ENABLE_VALIDATION_LAYERS</span></div><div class="line"><span class="keywordflow">if</span> (!activeLayers.empty())</div><div class="line">{</div><div class="line">        deviceInfo.enabledLayerCount = activeLayers.size();</div><div class="line">        deviceInfo.ppEnabledLayerNames = activeLayers.data();</div><div class="line">        LOGI(<span class="stringliteral">&quot;Using Vulkan device validation layers.\n&quot;</span>);</div><div class="line">}</div><div class="line"><span class="preprocessor">#endif</span></div></div><!-- fragment --><h1><a class="anchor" id="VLDebugCallback"></a>
Enabling Debug Callback</h1>
<p>Once we have created the instance with layer support and enabled VK_EXT_debug_report extension, we can create a debug callback.</p>
<div class="fragment"><div class="line">VULKAN_SYMBOL_WRAPPER_LOAD_INSTANCE_EXTENSION_SYMBOL(instance, vkCreateDebugReportCallbackEXT);</div><div class="line">VkDebugReportCallbackCreateInfoEXT info = { VK_STRUCTURE_TYPE_DEBUG_REPORT_CREATE_INFO_EXT };</div><div class="line">info.flags = VK_DEBUG_REPORT_ERROR_BIT_EXT | VK_DEBUG_REPORT_WARNING_BIT_EXT |</div><div class="line">                         VK_DEBUG_REPORT_PERFORMANCE_WARNING_BIT_EXT;</div><div class="line"></div><div class="line">info.pfnCallback = debugCallback;</div><div class="line">info.pUserData = <span class="keyword">this</span>;</div><div class="line"></div><div class="line"><span class="keywordflow">if</span> (vkCreateDebugReportCallbackEXT)</div><div class="line">        vkCreateDebugReportCallbackEXT(instance, &amp;info, <span class="keyword">nullptr</span>, &amp;debug_callback);</div><div class="line">LOGI(<span class="stringliteral">&quot;Enabling Vulkan debug reporting.\n&quot;</span>);</div></div><!-- fragment --><p>This callback usually just logs whatever the layer reports, but it's possible to filter out messages based on severity.</p>
<div class="fragment"><div class="line"><span class="keyword">static</span> VKAPI_ATTR VkBool32 VKAPI_CALL debugCallback(VkDebugReportFlagsEXT flags, VkDebugReportObjectTypeEXT type,</div><div class="line">                                                    uint64_t <span class="keywordtype">object</span>, <span class="keywordtype">size_t</span> location, int32_t messageCode,</div><div class="line">                                                    <span class="keyword">const</span> <span class="keywordtype">char</span> *pLayerPrefix, <span class="keyword">const</span> <span class="keywordtype">char</span> *pMessage, <span class="keywordtype">void</span> *pUserData)</div><div class="line">{</div><div class="line">        <span class="keywordflow">if</span> (flags &amp; VK_DEBUG_REPORT_ERROR_BIT_EXT)</div><div class="line">        {</div><div class="line">                LOGE(<span class="stringliteral">&quot;Validation Layer: Error: %s: %s\n&quot;</span>, pLayerPrefix, pMessage);</div><div class="line">        }</div><div class="line">        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (flags &amp; VK_DEBUG_REPORT_WARNING_BIT_EXT)</div><div class="line">        {</div><div class="line">                LOGE(<span class="stringliteral">&quot;Validation Layer: Warning: %s: %s\n&quot;</span>, pLayerPrefix, pMessage);</div><div class="line">        }</div><div class="line">        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (flags &amp; VK_DEBUG_REPORT_PERFORMANCE_WARNING_BIT_EXT)</div><div class="line">        {</div><div class="line">                LOGI(<span class="stringliteral">&quot;Validation Layer: Performance warning: %s: %s\n&quot;</span>, pLayerPrefix, pMessage);</div><div class="line">        }</div><div class="line">        <span class="keywordflow">else</span></div><div class="line">        {</div><div class="line">                LOGI(<span class="stringliteral">&quot;Validation Layer: Information: %s: %s\n&quot;</span>, pLayerPrefix, pMessage);</div><div class="line">        }</div><div class="line">        <span class="keywordflow">return</span> VK_FALSE;</div><div class="line">}</div></div><!-- fragment --><h1><a class="anchor" id="VKLink"></a>
Links</h1>
<p><a href="https://developer.android.com/ndk/guides/graphics/validation-layer.html">Vulkan Validation Layers - Android</a> </p>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="tutorials.html">Tutorials</a></li>
    <li class="footer">
        <a class="copyright" href="http://www.arm.com/">(C) ARM Ltd. 2016</a>
    </li>
  </ul>
</div>
</body>
</html>
