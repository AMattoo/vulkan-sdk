<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>Vulkan SDK for Android 1.1.1: Introduction to Vulkan on Android</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function()
{ (i[r].q=i[r].q||[]).push(arguments)}
,i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-35797182-1', 'auto');
ga('send', 'pageview');
</script>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="stylesheet.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0" width="100%">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="top_banner.bmp"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">Vulkan SDK for Android 1.1.1
<span id="malidevcenter"><a href="http://malideveloper.arm.com">Mali Developer Center</a></span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('creating_vulkan_window.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Introduction to Vulkan on Android </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>Shows you how to create a Vulkan instance, device and swapchain on Android.</p>
<h1><a class="anchor" id="creatingVulkanWindowNative"></a>
The Native Activity</h1>
<p>To get a Vulkan surface up and running, we will use native code exclusively, using NativeActivity. NativeActivity is a built-in Java class in Android which lets us implement applications purely in native code. This is very useful for Vulkan since in order to create a Vulkan swapchain, we need an ANativeWindow handle, which NativeActivity will neatly give us.</p>
<p>We set up a sample with this AndroidManifest.xml</p>
<div class="fragment"><div class="line">&lt;?xml version=<span class="stringliteral">&quot;1.0&quot;</span> encoding=<span class="stringliteral">&quot;utf-8&quot;</span>?&gt;</div><div class="line">&lt;manifest xmlns:android=<span class="stringliteral">&quot;http://schemas.android.com/apk/res/android&quot;</span></div><div class="line">      package=<span class="stringliteral">&quot;com.arm.vulkansdk.hellotriangle&quot;</span></div><div class="line">      android:versionCode=<span class="stringliteral">&quot;1&quot;</span></div><div class="line">      android:versionName=<span class="stringliteral">&quot;1.0&quot;</span>&gt;</div><div class="line">    &lt;application android:label=<span class="stringliteral">&quot;@string/app_name&quot;</span> android:icon=<span class="stringliteral">&quot;@drawable/ic_launcher&quot;</span> android:hasCode=<span class="stringliteral">&quot;false&quot;</span>&gt;</div><div class="line">        &lt;activity android:name=<span class="stringliteral">&quot;android.app.NativeActivity&quot;</span></div><div class="line">                  android:theme=<span class="stringliteral">&quot;@android:style/Theme.NoTitleBar.Fullscreen&quot;</span></div><div class="line">                  android:screenOrientation=<span class="stringliteral">&quot;landscape&quot;</span></div><div class="line">                  android:label=<span class="stringliteral">&quot;@string/app_name&quot;</span>&gt;</div><div class="line">            &lt;meta-data android:name=<span class="stringliteral">&quot;android.app.lib_name&quot;</span> android:value=<span class="stringliteral">&quot;native&quot;</span> /&gt;</div><div class="line">            &lt;intent-filter&gt;</div><div class="line">                &lt;action android:name=<span class="stringliteral">&quot;android.intent.action.MAIN&quot;</span> /&gt;</div><div class="line">                &lt;category android:name=<span class="stringliteral">&quot;android.intent.category.LAUNCHER&quot;</span> /&gt;</div><div class="line">            &lt;/intent-filter&gt;</div><div class="line">        &lt;/activity&gt;</div><div class="line">    &lt;/application&gt;</div><div class="line">&lt;/manifest&gt;</div></div><!-- fragment --><p>The important part here is that we set android.app.NativeActivity as our launch activity, where we set the android.app.lib_name meta-data. This is so that the Android class can load our application. Using android:value="native", Android will load libnative.so. We also set the android:hasCode="false" field, since we will not need to build any Java code ourselves.</p>
<p>Inside libnative.so, we need to include some glue code which will translate Java callbacks over to a classic main loop.</p>
<div class="fragment"><div class="line"><span class="comment">// platform/android/android.cpp</span></div><div class="line"><span class="preprocessor">#include &quot;android_native_app_glue.h&quot;</span></div><div class="line"><span class="keywordtype">void</span> android_main(android_app *state)</div><div class="line">{</div><div class="line">        <span class="comment">// Implement application here!</span></div><div class="line">        <span class="keywordflow">for</span> (;;)</div><div class="line">        {</div><div class="line">                ...</div><div class="line">                ALooper_pollAll(&amp;event);</div><div class="line">                <span class="keyword">event</span>-&gt;handle();</div><div class="line">        }</div><div class="line">}</div></div><!-- fragment --><p>In this mainloop, we will poll the android looper to receive and handle events. One of the events we will handle is obtaining a window handle. This window handle is required for creating a Vulkan swapchain.</p>
<div class="fragment"><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> engineHandleCmd(android_app *pApp, int32_t cmd)</div><div class="line">{</div><div class="line">        <span class="keywordflow">switch</span> (cmd)</div><div class="line">        {</div><div class="line">        <span class="keywordflow">case</span> APP_CMD_INIT_WINDOW:</div><div class="line">                ANativeWindow *pWindow = state-&gt;pApp-&gt;window;</div><div class="line">                <span class="comment">// Pass pWindow on to the application somehow.</span></div><div class="line">                <span class="keywordflow">break</span>;</div><div class="line">        }</div><div class="line">}</div></div><!-- fragment --><h1><a class="anchor" id="creatingVulkanContextBringup"></a>
Bringing up Vulkan Instance and Device</h1>
<p>After we have obtained a native window, we can create a Vulkan instance. The Vulkan instance is our first entry point into Vulkan.</p>
<div class="fragment"><div class="line">VkApplicationInfo app = { VK_STRUCTURE_TYPE_APPLICATION_INFO };</div><div class="line">app.pApplicationName = <span class="stringliteral">&quot;Mali SDK&quot;</span>;</div><div class="line">app.applicationVersion = 0;</div><div class="line">app.pEngineName = <span class="stringliteral">&quot;Mali SDK&quot;</span>;</div><div class="line">app.engineVersion = 0;</div><div class="line"><span class="comment">// API version used. What matters for compatibility is major (1) and minor (0) versions.</span></div><div class="line">app.apiVersion = VK_MAKE_VERSION(1, 0, 13);</div><div class="line"></div><div class="line">VkInstanceCreateInfo instanceInfo = { VK_STRUCTURE_TYPE_INSTANCE_CREATE_INFO };</div><div class="line">instanceInfo.pApplicationInfo = &amp;app;</div><div class="line"><span class="keywordflow">if</span> (useInstanceExtensions)</div><div class="line">{</div><div class="line">        instanceInfo.enabledExtensionCount = requiredInstanceExtensions.size();</div><div class="line">        instanceInfo.ppEnabledExtensionNames = requiredInstanceExtensions.data();</div><div class="line">}</div><div class="line"></div><div class="line">VkResult res = vkCreateInstance(&amp;instanceInfo, <span class="keyword">nullptr</span>, &amp;instance);</div></div><!-- fragment --><p>The Vulkan instance represents the "loader". The Vulkan loader serves as a common entrypoint for Vulkan on a particular platform, and it is vendor-agnostic. From the instance, we can query the available GPUs on the system.</p>
<div class="fragment"><div class="line">uint32_t gpuCount = 0;</div><div class="line">VK_CHECK(vkEnumeratePhysicalDevices(instance, &amp;gpuCount, <span class="keyword">nullptr</span>));</div><div class="line"></div><div class="line"><span class="keywordflow">if</span> (gpuCount &lt; 1)</div><div class="line">{</div><div class="line">        LOGE(<span class="stringliteral">&quot;Failed to enumerate Vulkan physical device.\n&quot;</span>);</div><div class="line">        <span class="keywordflow">return</span> RESULT_ERROR_GENERIC;</div><div class="line">}</div><div class="line"></div><div class="line">vector&lt;VkPhysicalDevice&gt; gpus(gpuCount);</div><div class="line">VK_CHECK(vkEnumeratePhysicalDevices(instance, &amp;gpuCount, gpus.data()));</div></div><!-- fragment --><p>From here we can query the VkPhysicalDevice about particular features if we want to select one GPU among many. Once we have decided on a GPU to use, we can create a device from it. The Vulkan device will from this point on serve as our entry for dispatching work to the GPU.</p>
<div class="fragment"><div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">float</span> one = 1.0f;</div><div class="line">VkDeviceQueueCreateInfo queueInfo = { VK_STRUCTURE_TYPE_DEVICE_QUEUE_CREATE_INFO };</div><div class="line">queueInfo.queueFamilyIndex = graphicsQueueIndex;</div><div class="line">queueInfo.queueCount = 1;</div><div class="line">queueInfo.pQueuePriorities = &amp;one;</div><div class="line"></div><div class="line">VkPhysicalDeviceFeatures features = { <span class="keyword">false</span> };</div><div class="line">VkDeviceCreateInfo deviceInfo = { VK_STRUCTURE_TYPE_DEVICE_CREATE_INFO };</div><div class="line">deviceInfo.queueCreateInfoCount = 1;</div><div class="line">deviceInfo.pQueueCreateInfos = &amp;queueInfo;</div><div class="line"><span class="keywordflow">if</span> (useDeviceExtensions)</div><div class="line">{</div><div class="line">        deviceInfo.enabledExtensionCount = requiredDeviceExtensions.size();</div><div class="line">        deviceInfo.ppEnabledExtensionNames = requiredDeviceExtensions.data();</div><div class="line">}</div><div class="line">deviceInfo.pEnabledFeatures = &amp;features;</div><div class="line"></div><div class="line">VK_CHECK(vkCreateDevice(gpu, &amp;deviceInfo, <span class="keyword">nullptr</span>, &amp;device));</div><div class="line"></div><div class="line"><span class="keywordflow">if</span> (FAILED(loadDeviceSymbols()))</div><div class="line">        <span class="keywordflow">return</span> RESULT_ERROR_GENERIC;</div><div class="line"></div><div class="line">vkGetDeviceQueue(device, graphicsQueueIndex, 0, &amp;queue);</div></div><!-- fragment --><h1><a class="anchor" id="creatingVulkanSwapchain"></a>
Creating a Vulkan Swapchain</h1>
<p>Now that we have a device, we can create a swapchain. A swapchain is the way for Vulkan applications to render to the screen. Vulkan can be used completely without a screen for off-line processing, and rendering to screen is done via a common extension, VK_KHR_swapchain.</p>
<p>First, we need to create a Vulkan surface.</p>
<div class="fragment"><div class="line">VkSurfaceKHR AndroidPlatform::createSurface()</div><div class="line">{</div><div class="line">        VkSurfaceKHR surface;</div><div class="line">        <span class="keyword">auto</span> fpCreateAndroidSurfaceKHR =</div><div class="line">            <span class="keyword">reinterpret_cast&lt;</span>PFN_vkCreateAndroidSurfaceKHR<span class="keyword">&gt;</span>(vkGetInstanceProcAddr(instance, <span class="stringliteral">&quot;vkCreateAndroidSurfaceKHR&quot;</span>));</div><div class="line"></div><div class="line">        <span class="keywordflow">if</span> (!fpCreateAndroidSurfaceKHR)</div><div class="line">                <span class="keywordflow">return</span> VK_NULL_HANDLE;</div><div class="line"></div><div class="line">        VkAndroidSurfaceCreateInfoKHR info = { VK_STRUCTURE_TYPE_ANDROID_SURFACE_CREATE_INFO_KHR };</div><div class="line">        info.window = pNativeWindow;</div><div class="line"></div><div class="line">        VK_CHECK(fpCreateAndroidSurfaceKHR(instance, &amp;info, <span class="keyword">nullptr</span>, &amp;surface));</div><div class="line">        <span class="keywordflow">return</span> surface;</div><div class="line">}</div></div><!-- fragment --><div class="fragment"><div class="line">VkSwapchainCreateInfoKHR info = { VK_STRUCTURE_TYPE_SWAPCHAIN_CREATE_INFO_KHR };</div><div class="line">info.surface = surface;</div><div class="line">...</div><div class="line"></div><div class="line">VK_CHECK(fpCreateSwapchainKHR(device, &amp;info, <span class="keyword">nullptr</span>, &amp;swapchain));</div></div><!-- fragment --><p>After the surface has been created, we do no longer have to deal with platform specific code in Vulkan. Once we have a swapchain, we can obtain the Vulkan images in the swapchain.</p>
<div class="fragment"><div class="line">uint32_t imageCount;</div><div class="line">VK_CHECK(fpGetSwapchainImagesKHR(device, swapchain, &amp;imageCount, <span class="keyword">nullptr</span>));</div><div class="line">swapchainImages.resize(imageCount);</div><div class="line">VK_CHECK(fpGetSwapchainImagesKHR(device, swapchain, &amp;imageCount, swapchainImages.data()));</div></div><!-- fragment --><p>For rendering to the screen, we will render to these images.</p>
<h1><a class="anchor" id="creatingVulkanSwapchainScreen"></a>
Rendering to Screen</h1>
<p>Once the swapchain is alive, we will render to screen by acquiring the swapchain, rendering to the appropriate image, and release it.</p>
<div class="fragment"><div class="line"><span class="keywordtype">unsigned</span> image;</div><div class="line">VkResult res = fpAcquireNextImageKHR(device, swapchain, UINT64_MAX, acquireSemaphore, VK_NULL_HANDLE, image);</div></div><!-- fragment --><p>We can now render to swapchainImages[image], and present it.</p>
<div class="fragment"><div class="line">Result WSIPlatform::presentImage(<span class="keywordtype">unsigned</span> index)</div><div class="line">{</div><div class="line">        VkResult result;</div><div class="line">        VkPresentInfoKHR present = { VK_STRUCTURE_TYPE_PRESENT_INFO_KHR };</div><div class="line">        present.swapchainCount = 1;</div><div class="line">        present.pSwapchains = &amp;swapchain;</div><div class="line">        present.pImageIndices = &amp;index;</div><div class="line">        present.pResults = &amp;result;</div><div class="line">        present.waitSemaphoreCount = 1;</div><div class="line">        present.pWaitSemaphores = &amp;pContext-&gt;getSwapchainReleaseSemaphore();</div><div class="line"></div><div class="line">        VkResult res = fpQueuePresentKHR(queue, &amp;present);</div><div class="line"></div><div class="line">        <span class="keywordflow">if</span> (res == VK_SUBOPTIMAL_KHR || res == VK_ERROR_OUT_OF_DATE_KHR)</div><div class="line">                <span class="keywordflow">return</span> RESULT_ERROR_OUTDATED_SWAPCHAIN;</div><div class="line">        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (res != VK_SUCCESS)</div><div class="line">                <span class="keywordflow">return</span> RESULT_ERROR_GENERIC;</div><div class="line">        <span class="keywordflow">else</span></div><div class="line">                <span class="keywordflow">return</span> RESULT_SUCCESS;</div><div class="line">}</div></div><!-- fragment --><h1><a class="anchor" id="creatingVulkanMainLoop"></a>
Running the Main Loop in android_main</h1>
<p>Once everything is initialized, we will drive our application from the main loop</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> android_main(android_app *state)</div><div class="line">{</div><div class="line">        <span class="comment">// ...</span></div><div class="line">        <span class="keywordflow">for</span> (;;)</div><div class="line">        {</div><div class="line">                <span class="keywordflow">while</span> (ALooper_pollAll())</div><div class="line">                {</div><div class="line">                        <span class="comment">// Handle events</span></div><div class="line">                }</div><div class="line"></div><div class="line">                <span class="keywordflow">if</span> (engine.pVulkanApp)</div><div class="line">                {</div><div class="line">                        <span class="comment">// Acquire next image</span></div><div class="line">                        <span class="comment">// Deal with outdated swapchain if needed</span></div><div class="line">                        <span class="comment">// Render</span></div><div class="line">                        <span class="comment">// Present</span></div><div class="line">                }</div><div class="line">        }</div><div class="line">}</div></div><!-- fragment --><h1><a class="anchor" id="creatingVulkanSwapchainDealing"></a>
Dealing with Out-of-Date Swapchains</h1>
<p>After acquiring a swapchain it is possible that the swapchain becomes outdated via error codes VK_SUBOPTIMAL_KHR and VK_ERROR_OUT_OF_DATE_KHR. This is possible if the surface has rotated or otherwise resized in any way. In this case, the swapchain must be recreated in order to obtain new VkImages for the backbuffers.</p>
<p>It is possible to recycle the old swapchain in this case.</p>
<div class="fragment"><div class="line">VkSwapchainCreateInfoKHR info = { VK_STRUCTURE_TYPE_SWAPCHAIN_CREATE_INFO_KHR };</div><div class="line">...</div><div class="line">info.oldSwapchain = oldSwapchain;</div><div class="line">VK_CHECK(fpCreateSwapchainKHR(device, &amp;info, <span class="keyword">nullptr</span>, &amp;swapchain));</div><div class="line"><span class="keywordflow">if</span> (oldSwapchain != VK_NULL_HANDLE)</div><div class="line">        fpDestroySwapchainKHR(device, oldSwapchain, <span class="keyword">nullptr</span>);</div></div><!-- fragment --> </div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="tutorials.html">Tutorials</a></li>
    <li class="footer">
        <a class="copyright" href="http://www.arm.com/">(C) ARM Ltd. 2016</a>
    </li>
  </ul>
</div>
</body>
</html>
